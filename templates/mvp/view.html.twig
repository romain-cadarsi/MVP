{% extends 'baseMobile.html.twig' %}
{% block css %}
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Cabin:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    <style>
        .flickity-page-dots{
            z-index: 1000 !important;
        }
        .carousel img{
            height: 100% !important;
        }
        .carousel .polo-carousel-item{
            height: 100% !important;
        }


        .participer
        {
            line-height: 56px !important ;
        }



    </style>

    <style>
        p,a,h1,h2,h3,label{
            font-family: Cabin !important;
        }
        span{
            font-family: Cabin;
        }

        .flickity-page-dots{
            z-index: 1000 !important;
        }
        .carousel img{
            height: 100% !important;
        }
        .carousel .polo-carousel-item{
            height: 100% !important;
        }

        .imagesParticipations::after{
            content: "{{campagne.nombreParticipations}}/{{campagne.nombreParticipants}}";
            position: absolute;
            color: #c6c9cd;
            right: 0;
            top: 10px;
            font-size: 13px;
            font-weight: 400;
        }
        li {
            display: inline-block;
            font-size: 15px;
            list-style-type: none;
            padding: 5px;
            text-transform: uppercase;

        }

        li span {
            display: block;
            font-size: 4.5rem;
        }

        .has-error input, .has-error textarea{
            border-color: red;
            color: red;
        }
        .has-error .messages p{
            color: red;
        }

        .has-success input,.has-success textarea{
            border-color: #4CD964;
            color: #4CD964;
        }
        .has-success .input::after{
            content: "✓";
            position: relative;
            left: calc(100% - 30px);
            font-size: 27px;
            top: -30px;
            color: #4CD964;
        }

        #mainMenu ul{
            width: 50%;
            margin: 0 auto !important;
            text-align: center;
        }
        .center {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }
        .minicontainer{
            padding : 50px 50px;
        }
        @media all and (max-width: 1000px)
        {
            #mainMenu ul{
                width: 100%;
                margin: 0 auto !important;
                text-align: center;
            }
            .participer{
                line-height: 50px !important;
                padding : 0 50px 50px !important;
            }
            .minicontainer{
                padding: 0px;
            }

        }

    </style>

{% endblock %}
{% block bodycontent  %}
    <div id="loader" style="width: 100vw; height: 100vh;position:fixed; background-color: white; z-index: 1000;" class="hidden">
        <div class="center" style="height: auto;background-color: #0ee6b0; margin : 0 auto;border-radius: 20px;width: 300px;">
            <div style="padding: 20px;">
                <p style="line-height: 1.2;font-size: 1.5vw;color: white;font-weight: 400;margin-bottom: 20px;"><span id="action" style="font-size: 18px;">Enregistrement de la commande</span></p>
                <div style="position:relative; height: 25px">
                    <div style="position:absolute; /*! top:5vw ; */ width: 300px; background-color: #8ed2bb;height: 0.5vh;left: -20px;"></div>
                    <div id="avancee" style="position: absolute; top: 0; width: 100%; background-color: rgb(6, 121, 90); height: 0.5vh;left: -20px;">
                    </div>


                </div><p style="font-size: 2rem;line-height: 0.5;color: white;font-weight: 900;"><span id="avanceenb">100</span>%</p>
            </div>
        </div>
    </div>
    <section id="product-page" class="product-page p-b-0" style="border-radius: 20px">
        <div class="container">
            <div class="product">
                <div class="row m-b-40">
                    <div class="col-lg-5">
                        <div class="product-image">
                          <img src="/{{ campagne.logo.asset }}">
                            <img id="previewMethod" style="position: absolute;right: 0;bottom: 0; height: 60px ; width: auto" src="{% if campagne.moyen == "collect"%}  {{ asset('collect.png') }} {% else %} {{ asset('livraison.png') }} {% endif %}">
                            <div id="countdown" style="color: white; position:absolute; top: 0; left: 0; background-color: #5be7c4;border-radius: 20px;height: 50px; text-align: center">
                                <ul>
                                    <li style="font-size: 9px;filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.2));"><span style="font-size: 22px;letter-spacing: -0.003em;font-weight: 900;" id="days"></span>Jours</li>
                                    <span style="font-size: 16px;line-height: 0px;position: relative;bottom: 10px; filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.2))">:</span>
                                    <li style="font-size: 9px;filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.2));"><span style="font-size: 22px;letter-spacing: -0.003em;font-weight: 900;" id="hours"></span>Heures</li>
                                    <span style="font-size: 16px;line-height: 0px;position: relative;bottom: 10px;filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.2))">:</span>
                                    <li style="font-size: 9px;filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.2));"><span style="font-size: 22px;letter-spacing: -0.003em;font-weight: 900;" id="minutes"></span>Minutes</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="product-description" style="position:relative;">
                            <h6 style="line-height: 0.1em;font-family: Cabin;font-style: normal;font-weight: 600;font-size: 15px;line-height: 20px;color: #73c9cf;" >Meze  <span class="fa fa-map-marker"></span> </h6>
                            <h6 style="line-height: 0.1em;font-family: Cabin;font-style: normal;font-weight: 400;font-size: 15px;line-height: 20px;color: #979797;">Caviste Meze</h6>
                            <div class="product-title">

                                <h3  style="width : 80%;font-size: 2vh;font-weight: 700;letter-spacing: 0.1px;color: #304c44;" id="preview-titre">{{ campagne.titre }}</h3>
                            </div>
                            <div class="product-price"><ins style="font-size: 3.084vh;line-height: 0.5;font-weight: 900;color: #54c2a5;">€ {{ campagne.prixPromotion }}</ins>
                            </div>

                            <div class="product-reviews"><a href="#" style="text-decoration: line-through"> € {{ campagne.valeurProduit }}</a>
                            </div>
                            <p>{{ campagne.description }}</p>
                        </div>
                        <p style="font-size: 24px;font-weight: 600;line-height: 30px;color: #194238;"> Objectif Participatif  <a data-lightbox="ajax" href="{{ path('helpBoost') }}">
                                <span class="fa fa-question-circle" style="font-size: 17px;color: grey;" aria-hidden="true"></span></a>
                        </p>
                        <div class="barres" style="width: 80%; position: relative;height: 40px;">
                            <div style="position: absolute;width: 100%;height: 20px;background-color: #F2F3F5;border-radius: 20px;/*! top: 370px; *//*! left: 80px; */">
                            </div>

                            <div style="position: absolute;width: {{ campagne.pourcentageParticipation }}%;height: 20px;background-color: #5be7c4;border-radius: 20px;/*! top: 370px; *//*! left: 80px; */">
                            </div>
                        </div>
                        <div class="imagesParticipations" style="position: relative;height: 60px/*! left: 80px; */">
                            <div style="width: 4vh;height: 4vh;border-radius: 50px;background-color: white;border: 1px solid gray; position:absolute; background-image: url('{{ asset('Ellipse.png') }}') ; background-size: contain;">
                            </div>
                            <div style="width: 4vh;height: 4vh;border-radius: 50px;background-color: white;border: 1px solid gray;position: absolute;left: 4% ;background-image: url('{{ asset('Ellipse(1).png') }}') ; background-size: contain;">
                            </div>
                            <div style="width: 4vh;height: 4vh;border-radius: 50px;background-color: white;border: 1px solid gray;position: absolute;left: 8%;background-image: url('{{ asset('Ellipse(2).png') }}') ; background-size: contain;">
                            </div>
                            <div style="width: 4vh;height: 4vh;border-radius: 50px;background-color: white;border: 1px solid gray;position: absolute;left: 12%;background-image: url('{{ asset('Ellipse(3).png') }}') ; background-size: contain;">
                            </div>
                            <div style="width: 4vh;height: 4vh;border-radius: 50px;background-color: white;border: 1px solid gray;position: absolute;left: 16%;padding: 2%;font-size: 1.2vh;color: white;background-color: #5ae5c2;font-weight: 600;">
                                +<d id="nbParticipantsPreview">{{ campagne.nombreParticipations }}</d>
                            </div>
                        </div>                        <div class="row">


                            <div class="col-lg-6">
                                <div class="cart-product-quantity" style="text-align: right;">
                                    <div class="quantity m-l-5" style="margin-bottom: 20px;">
                                        <input type="button" class="minus" value="-">
                                        <input type="text" class="qty" value="1" style="border: none;text-align: right;background-color: rgba(178, 254, 235, 1);">
                                        <input type="button" class="plus" value="+">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 text-center">
                                <btn href="#modal-auto-open" data-lightbox="inline" class="btn btn-rounded btn-reveal btn-lg participer"><span>Participer</span><i class="icon-chevron-right"></i></btn>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div id="modal-auto-open" class="modal modal-active mfp-hide">
        <form id="form">
        <div class="row">
            <div class="col-6 form-group">
                <label for="telephone" style="width: 100%;font-weight: 600;font-size: 18px;text-align: left; color: rgba(66, 67, 71, 1)">Telephone</label>
                <div class="input">
                <input type="text" id="telephone" name="telephone" class="form-control" style="width: 80%;text-align: left;">
                </div>
                <p class="messages"></p>
            </div>
            <div class="col-6 form-group">
                <label for="email" style="width: 100%;font-weight: 600;font-size: 18px;text-align: left; color: rgba(66, 67, 71, 1)">Email</label>
                <div class="input">
                <input type="email" id="email" name="email" class="form-control" style="width: 80%">
                </div>
                <p class="messages"></p>
            </div>
            <div class="form-group">  <input hidden name="idCampagne" value="{{ campagne.id }}"></div>

        </div>
            <button title="Close (Esc)" style="color: lightgrey" type="button" class="mfp-close">×</button>
        <div class="text-center" style="padding-top: 20px">

            <button type="submit" class="btn btn-lg" style="text-transform: none;font-size: 18px;letter-spacing: -0.16px;font-weight: 700;line-height: 38px;"> Confirmer </button>
        </div>
        </form>
    </div>

{% endblock %}
{% block js %}
    <script defer>



    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="{{ asset('Template/plugins/validate/validate.js') }}"></script>
    <script>
        (function () {
            const second = 1000,
                minute = second * 60,
                hour = minute * 60,
                day = hour * 24;

            let birthday = "{{ campagne.debutCampagne | date("M j, Y H:i:s ")}}"
            countDown = (new Date(birthday)).getTime() + 86400000 * {{ campagne.dureeCampagne }},
                x = setInterval(function() {

                    let now = new Date().getTime(),
                        distance = countDown - now;

                    document.getElementById("days").innerText = Math.floor(distance / (day));
                    document.getElementById("hours").innerText = Math.floor((distance % (day)) / (hour));
                    document.getElementById("minutes").innerText = Math.floor((distance % (hour)) / (minute));
                    //seconds
                }, 0)
        }());
    </script>

    <script>


        (function() {
            // Before using it we must add the parse and format functions
            // Here is a sample implementation using moment.js
            validate.extend(validate.validators.datetime, {
                // The value is guaranteed not to be null or undefined but otherwise it
                // could be anything.
                parse: function(value, options) {
                    return +moment.utc(value);
                },
                // Input is a unix timestamp
                format: function(value, options) {
                    var format = options.dateOnly ? "YYYY-MM-DD" : "YYYY-MM-DD hh:mm:ss";
                    return moment.utc(value).format(format);
                }
            });

            // These are the constraints used to validate the form
            var constraints = {
                email: {
                    // Email is required
                    presence: true,
                    // and must be an email (duh)
                    email: true,
                },
                telephone: {
                    // Password is also required
                    presence: true,
                    // And must be at least 5 characters long

                },

            };


            // Hook up the inputs to validate on the fly
            var inputs = document.querySelectorAll("input, textarea, select")
            for (var i = 0; i < inputs.length; ++i) {
                inputs.item(i).addEventListener("change", function(ev) {
                    var errors = validate(form, constraints) || {};
                    showErrorsForInput(this, errors[this.name])
                });
            }

            function handleFormSubmit(form, input) {
                // validate the form against the constraints
                var errors = validate(form, constraints);
                // then we update the form to reflect the results
                showErrors(form, errors || {});
                return !errors;
            }

            // Updates the inputs with the validation errors
            function showErrors(form, errors) {
                // We loop through all the inputs and show the errors for that input
                _.each(form.querySelectorAll("input[name], select[name]"), function(input) {
                    // Since the errors can be null if no errors were found we need to handle
                    // that
                    showErrorsForInput(input, errors && errors[input.name]);
                });
            }

            // Shows the errors for a specific input
            function showErrorsForInput(input, errors) {
                // This is the root of the input
                var formGroup = closestParent(input.parentNode, "form-group")
                    // Find where the error messages will be insert into
                    , messages = formGroup.querySelector(".messages");
                // First we remove any old messages and resets the classes
                resetFormGroup(formGroup);
                // If we have errors
                if (errors) {
                    // we first mark the group has having errors
                    formGroup.classList.add("has-error");
                    // then we append all the errors
                    _.each(errors, function(error) {
                        addError(messages, error);
                    });
                } else {
                    // otherwise we simply mark it as success
                    formGroup.classList.add("has-success");
                }
            }

            // Recusively finds the closest parent that has the specified class
            function closestParent(child, className) {
                if (!child || child == document) {
                    return null;
                }
                if (child.classList.contains(className)) {
                    return child;
                } else {
                    return closestParent(child.parentNode, className);
                }
            }

            function resetFormGroup(formGroup) {
                // Remove the success and error classes
                formGroup.classList.remove("has-error");
                formGroup.classList.remove("has-success");
                // and remove any old messages
                _.each(formGroup.querySelectorAll(".help-block.error"), function(el) {
                    el.parentNode.removeChild(el);
                });
            }

            // Adds the specified error with the following markup
            // <p class="help-block error">[message]</p>
            function addError(messages, error) {
                var block = document.createElement("p");
                block.classList.add("help-block");
                block.classList.add("error");
                block.innerText = error;
                messages.appendChild(block);
            }
            function goTo100(action){
                $(action).each(function (){

                })
                $('#avancee').css('width','0%');
                $('#action').html(action)
                let percentage = 0;
                let interval = setInterval(function (){
                    if(percentage > 99){
                        clearInterval(interval)
                    }
                    else{
                        percentage += 1;
                        $('#avancee').css('width',(percentage / 100) * 300 +'px');
                        $('#avanceenb').html(percentage)
                    }
                },15)
            }

            function launchAnimation(){
                $('#loader').show();
                goTo100("Création de la participation")
                setTimeout(function (){
                    goTo100("Notification vendeur")
                    setTimeout(function (){
                        goTo100("Enregistrement de la commande")
                        setTimeout(function (){
                            $('#loader').trigger('animationFinished');
                        },1500)
                    },1500)
                },1500)
            }
            let ok = false;

            $("#form").on('submit',function(e) {

                e.preventDefault();
                e.stopPropagation();
                if( handleFormSubmit(this)){
                    $('.mfp-close').click()
                    launchAnimation()
                    var formData = new FormData(this);
                    $.ajax({
                        url: '{{ path('createParticipation') }}',
                        type: 'POST',
                        data: formData,
                        success: function (data) {
                            $('#loader').on('animationFinished',function (){
                               window.location = data
                            })


                        },
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                }

            });

        })();

    </script>
{% endblock %}